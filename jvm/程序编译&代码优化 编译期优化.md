## 编译期优化

### 1. 定义及用途

* Java中编译可能在编译器发生，可能在运行期发生，可能是编译成字节码，可能是编译成机器码
* 前端编译器：发生于运行前，.java文件转为字节码；代表有：sun的javac
* JIT编译器：Just In Time C; 发生于运行期，字节码为机器码；代表有：HotSpot VM 的 C1 C2
* AOT编译器：Ahead Of Time C;发生于运行前，.java文件转为机器码；代表有：GNU C For Java
* javac做了很多对**Java编译过程**的优化，以此改善Java编码风格&提高编码效率，相当一部分Java新语法特性就是建立在编译器上实现的，而没有对Java虚拟机底层做更改；
  * 非常典型的代表就是泛型，编译后，类型擦除，根本不会有任何泛型

### 2. 相对同类产品优势

* 

### 3. 核心知识点

#### 3.1. javac 编译过程

* 解析与填充符号表过程
* 插入式注解处理器的注解处理过程
* 分析与字节码生成过程

##### 3.1.1. 解析与填充符号表

* 词法，语法分析
  * 词法分析：将源代码的**字符流**转换为**标记Token**集合
    * 标记是编译过程的最小元素，不可拆分
  * 语法分析：根据**Token序列**构造**抽象语法树AST**，得到对源程序的抽象
    * 语法树的每个节点代表一个语法结构：如运算符，返回值等
* 填充符号表
  * 符号表：符号地址和符号信息构成的表格
  * 用于语义检查
  * 用于产生中间代码
  * 用于对符号名进行地址分配
  * 如果用户没给构造函数
    * 编译器添加 一个 没有参数 访问性与当前类一致 的默认构造函数

---

##### 3.1.2. 注解处理器

* 可以读取、修改、添加抽象语法树中的任意元素
* 一旦注解处理器处理期间对AST做了修改，则编译器会回到解析与填充符号表过程重新处理

---

##### 3.1.3. 语义分析与字节码生成

* 语义分析：对结构正确的源程序进行上下文有关性质的审查，确保源程序符合逻辑
  * 标注检查：
    * 检查变量使用前是否已经声明
    * 检查变量与赋值之间的数据类型是否匹配
    * 常量折叠：int a = 1 + 2 => int a = 3
  * 数据及控制流分析：
    * 检查局部变量使用前是否赋值
    * 方法的每条路径是否都有返回值
    * 检查所有受检查异常是否都被正确处理
* 解语发糖
  * 语法糖：Syntactic Sugar，增加代码的可读性，更方便使用，但对语言的功能并没有影响
  * Java常用语法糖：泛型、变长参数、自动装箱/拆箱
  * 解语发糖：虚拟机运行时并不支持这些语法糖，在编译阶段将语法糖还原成简单的基础语法结构
* 字节码生成：
  * javac编译过程的最后一个阶段
  * 任务：
    * 将AST等信息转换成字节码存放发哦磁盘中
    * 代码添加&转换
      * 添加实例构造方法<init>()，类构造方法<clinit>()到AST
      * 字符串+操作，替换为StringBuffer或StringBuilder的append()方法

---

#### 3.2. Java语法糖

* 语法糖不提供实质的功能改进，提高编码效率，提升语法严谨性

##### 3.2.1. 泛型与类型擦除

* 真实泛型
  * C#的泛型存在于源码中，编译后的IL中，运行期的CLR中
  * 运行期时，List<Integer> 和 List<String>就是两种类型
  * C#使用类型膨胀来实现泛型
* 伪泛型
  * Java的泛型只存在于  源码中，编译后替换为原生类型
  * 运行期时，List<Integer> 和 List<String>是同一种类型
  * Java使用类型擦除来实现泛型
    * Signature属性：存储一个方法在字节码层面的特征签名，保存参数化类型的信息
    * 擦除仅擦除方法的Code属性的字节码
    * 元数据还保留了泛型信息，这使得能够通过反射获取参数化类型

---

##### 3.2.2. 自动装箱/拆箱&遍历循环

* 遍历循环需要被遍历的类实现迭代器接口
  * 因为遍历循环式语法糖，编译后就是迭代器实现
* 包装类的“==” 在不遇到算术运算的情况下 不会自动拆箱
* 包装类的equals()方法不处理数据转型，如Long类型，会先执行` obj instanceof Long`

---

##### 3.2.3. 条件编译

* 使用**条件为常量**的if语句
  * 该语句编译阶段就会运行
* 根据布尔值真假，编译器会把不成立的分支代码消除掉
* 受到if语法的约束，只能实现语句基本块级别的条件编译

---

### 4. 常见面试题

### 5. 综述

### 6. 参考资料

- 《深入Java虚拟机-JVM高级特性与最佳实践》

